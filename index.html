<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Melbourne Public Transport – Data Story (ABS 2021 + PTV)</title>

  <!-- Vega, Vega-Lite, Vega-Embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    :root{
      --maxw: 1200px; --ink:#111827; --muted:#6b7280; --card:#ffffff; --bg:#fafafa; --rule:#e5e7eb;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:0 16px;}
    h1{font-size:2rem;margin:0 0 8px;}
    .subtitle{color:var(--muted);margin-bottom:24px;max-width:80ch}
    h2{font-size:1.35rem;margin:24px 0 6px}
    p.lead{color:var(--muted);margin:0 0 14px}
    .card{background:var(--card);border:1px solid var(--rule);border-radius:14px;padding:16px;margin:16px 0;box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .vis{width:100%}
    .smallnote{color:var(--muted);font-size:.9rem;margin-top:8px}
    footer{margin:32px 0;color:var(--muted);font-size:.9rem}

    /* Center the shared FY selector */
    .center-binds .vega-bindings{
      display:flex;justify-content:center;gap:10px;margin:8px 0 4px;font-size:0.95rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Melbourne Public Transport – How Has it Evolved in Recent Years?</h1>
      <div class="subtitle">How Melburnians rely on PT (<strong>ABS 2021</strong>), how the transport mode mix has changed over time (<strong>PTV DataVic</strong>), and which stations anchor the network across Victoria.</div>
    </header>

    <!-- SECTION 1: Map -->
    <section class="card">
      <h2>Where Melburnians Rely Most on Public Transport</h2>
      <p class="lead">Inner-city and corridor suburbs show the highest dependence on PT, reflecting dense rail and tram access. Triangle markers highlight the 20 busiest stations in the selected year—clustered around the CBD and key junctions like Richmond, Caulfield and Footscray.</p>
      <div id="map" class="vis"></div>
      <div class="smallnote">Sources: ABS 2021 Census (G62), ASGS 2021 SA2; PTV Annual Metropolitan Station Entries (FY20–21, FY23–24, FY24–25).</div>
    </section>

    <!-- SECTION 2: Area (alone) -->
    <section class="card">
      <h2>How Public Transport Usage Evolved Before and After COVID-19</h2>
      <p class="lead">Usage fell sharply during 2020 when COVID hit, then steadily recovered after border reopenings in early 2022. Trains remain the backbone, with trams and buses providing steady inner-suburban and feeder capacity. Recovery is ongoing and still shy of pre-pandemic peaks, possibly influenced by the rise of working from home.</p>
      <div id="stacked-area" class="vis center-binds"></div>
      <div class="smallnote">Source: Department of Transport &amp; Planning (Vic) — Monthly public transport patronage by mode.</div>
    </section>

    <!-- SECTION 3: Donut + Key Transport Hubs side-by-side (shared FY) -->
    <section class="card">
      <h2>Which Mode Carries Melburnians & Key Transport Hubs</h2>
      <p class="lead">Select a financial year to see total trips by mode (left) and the busiest stations for that same year (right). Colours match across visuals: Train = blue, Tram = green, Bus = grey.</p>
      <div id="share-pair" class="vis center-binds"></div>
    </section>

    <!-- SECTION 4: SA2 scatter -->
    <section class="card">
      <h2>Does Density Drive Public Transport Use?</h2>
      <p class="lead">
        Suburbs (SA2) with more employed commuters per square kilometre tend to have a higher share using public transport.
        Bubble size shows the number of PT commuters. The red line is a linear regression fit. Outliers at the far right
        (e.g., Melbourne - CBD North) have very high densities but a lower PT share than expected in 2021; at the other end,
        coastal inner suburbs like Elwood also sit below the trend, likely reflecting gaps or indirect access to heavy rail compared with tram rich or station adjacent areas.
      </p>
      <div id="sa2-scatter" class="vis"></div>
      <div class="smallnote">Sources: ABS 2021 Census (SA2 boundaries &amp; travel to work).</div>
    </section>
  </div>
  

  <script>
    /* Shared colours: Train blue, Tram green, Bus grey */
    const MODE_COLOUR = {
      domain: ["Metropolitan train","Metropolitan tram","Metropolitan bus"],
      range:  ["#0B5FFF",           "#00B368",           "#9CA3AF"]
    };

    /* Map selector */
    const stationYearParam = {
      name: "StationYear",
      value: 2024,
      bind: {
        input: "select",
        options: [2020, 2023, 2024],
        labels: ["2020–21 (COVID year)", "2023–24 (recovery)", "2024–25 (latest)"]
      }
    };

    /* -------- MAP -------- */
    const mapSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container", height: 560, autosize: { type: "fit", contains: "padding" },
      params: [stationYearParam],
      projection: { type: "mercator" },
      data: { url: "data/melb_sa2_simplified.geojson", format: { type: "json", property: "features" } },
      transform: [
        { calculate: "toString(datum.properties.SA2_CODE_2021)", as: "SA2_CODE_2021_str" },
        {
          lookup: "SA2_CODE_2021_str",
          from: {
            data: { url: "data/abs_sa2_travel_to_work_2021.csv",
                    format: { type: "csv", parse: { SA2_CODE_2021: "string", PT_percent: "number", PT_Total: "number", Commuted_Total: "number" } } },
            key: "SA2_CODE_2021",
            fields: ["PT_percent","PT_Total","Commuted_Total"]
          }
        }
      ],
      layer: [
        { mark: { type: "geoshape", fill: "#f3f4f6", stroke: "#bdbfc3", strokeWidth: 0.6 } },
        {
          transform: [{ filter: "isValid(datum.PT_percent)" }],
          mark: { type: "geoshape", stroke: "#ffffff", strokeWidth: 0.35, opacity: 0.98 },
          encoding: {
            color: {
              field: "PT_percent", type: "quantitative", title: "% using Public Transport",
              scale: { type: "sqrt", domain: [0,45], range: ["#dbeafe","#60a5fa","#2563eb","#1e3a8a"], clamp: true }
            },
            tooltip: [
              { field: "properties.SA2_NAME_2021", title: "Area" },
              { field: "PT_percent", type: "quantitative", format: ".1f", title: "% PT" },
              { field: "PT_Total", type: "quantitative", title: "PT commuters" },
              { field: "Commuted_Total", type: "quantitative", title: "Commuters (excl. WFH)" }
            ]
          }
        },
        {
          data: { url: "data/station_usage.csv",
                  format: { type: "csv", parse: { Entries:"number", Latitude:"number", Longitude:"number", Year:"number" } } },
          transform: [
            { filter: "datum.Year == StationYear" },
            { window: [{ op: "rank", as: "rk" }], sort: [{ field: "Entries", order: "descending" }] },
            { filter: "datum.rk <= 20" }
          ],
          mark: { type: "point", shape: "triangle-up", filled: true, opacity: 0.85, stroke: "#111", strokeWidth: 0.9 },
          encoding: {
            longitude: { field: "Longitude" }, latitude: { field: "Latitude" },
            size: { field: "Entries", type: "quantitative", title: "Entries", scale: { range: [40, 320] } },
            color: { value: "#000000" }, /* black triangles */
            tooltip: [{ field: "Station" }, { field: "Entries", type: "quantitative", format: "," }, { field: "Year", type: "quantitative" }]
          }
        }
      ],
      config: { view: { stroke: null } }
    };

    /* -------- AREA (alone) -------- */
    const stackedAreaSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container", height: 420, autosize: { type: "fit", contains: "padding" },
      data: { url: "data/monthly_public_transport_patronage_by_mode.csv" },
      transform: [
        { calculate: "toNumber(datum.Year)", as: "Year" },
        { calculate: "toNumber(datum.Month)", as: "Month" },
        { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Patronage"] },
        { calculate: "datetime(datum.Year, datum.Month-1, 1)", as: "MonthDate" }
      ],
      layer: [
        {
          mark: { type: "area", interpolate: "monotone" },
          encoding: {
            x: { field: "MonthDate", type: "temporal", title: "Month" },
            y: { field: "Patronage", type: "quantitative", stack: "zero", title: "Trips", axis: { format: "~s" } },
            color: { field: "Mode", type: "nominal", scale: MODE_COLOUR, title: "Mode" },
            tooltip: [
              { field: "MonthDate", type: "temporal", title: "Month" },
              { field: "Mode" },
              { field: "Patronage", type: "quantitative", format: "," }
            ]
          }
        },
        { data: { values: [{ date: "2022-01-01" }] },
          mark: { type: "rule", color: "red", strokeDash: [4,3], strokeWidth: 2 },
          encoding: { x: { field: "date", type: "temporal" } }
        },
        /* Caption higher in the white area */
        { data: { values: [{ date: "2022-01-01", label: "Border reopening after COVID-19" }] },
          mark: { type: "text", align: "left", dx: 10, dy: -140, color: "red", fontSize: 12, fontWeight: "bold" },
          encoding: { x: { field: "date", type: "temporal" }, y: { datum: 0 }, text: { field: "label" } }
        }
      ],
      config: { view: { stroke: null } }
    };

    /* -------- DONUT + HUBS side-by-side (shared FY) -------- */
    const sharePairSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      params: [{
        name: "FY",
        value: 2024,
        bind: { input: "select", options: [2020, 2023, 2024],
                labels: ["2020–21 (COVID year)", "2023–24 (recovery)", "2024–25 (latest)"] }
      }],
      hconcat: [
        /* Donut */
        {
          width: 420, height: 360,
          data: { url: "data/monthly_public_transport_patronage_by_mode.csv" },
          transform: [
            { calculate: "toNumber(datum.Year)", as: "YearNum" },
            { calculate: "toNumber(datum.Month)", as: "MonthNum" },
            { calculate: "datum.MonthNum >= 7 ? datum.YearNum : datum.YearNum - 1", as: "FiscalStart" },
            { filter: "datum.FiscalStart == FY" },
            { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Trips"] },
            { aggregate: [{ op: "sum", field: "Trips", as: "TotalTrips" }], groupby: ["Mode"] }
          ],
          mark: { type: "arc", innerRadius: 110, stroke: "#fff" },
          encoding: {
            theta: { field: "TotalTrips", type: "quantitative" },
            color: { field: "Mode", type: "nominal", scale: MODE_COLOUR, title: "Mode" },
            tooltip: [{ field: "Mode" }, { field: "TotalTrips", type: "quantitative", format: "," }]
          }
        },
        /* Hubs (Top-20), shares FY param */
        {
          width: 620, height: 360,
          data: { url: "data/station_usage.csv", format: { type: "csv", parse: { Year: "number", Entries: "number" } } },
          transform: [
            { filter: "datum.Year == FY" },
            { window: [{ op: "rank", as: "rk" }], sort: [{ field: "Entries", order: "descending" }] },
            { filter: "datum.rk <= 20" }
          ],
          mark: { type: "bar", cornerRadiusTopLeft: 6, cornerRadiusTopRight: 6 },
          encoding: {
            y: { field: "Station", type: "nominal", sort: "-x", title: "Station" },
            x: { field: "Entries", type: "quantitative", title: "Annual entries", axis: { format: "~s" } },
            color: { value: "#1e3a8a" }, /* navy */
            tooltip: [{ field: "Station" }, { field: "Entries", type: "quantitative", format: "," }, { field: "Year", type: "quantitative" }]
          }
        }
      ],
      config: { view: { stroke: null } }
    };

    /* -------- SA2 SCATTER -------- */
    const sa2ScatterSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container", height: 460, autosize: { type: "fit", contains: "padding" },
      data: { url: "data/sa2_pt_density.csv",
              format: { type: "csv", parse: {
                Density_commuters: "number", PT_percent: "number", PT_Total: "number", Area_sqkm: "number"
              } } },
      transform: [{ calculate: "datum.PT_percent", as: "PT_pct" }],
      layer: [
        {
          mark: { type: "point", filled: true, opacity: 0.7 },
          encoding: {
            x: { field: "Density_commuters", type: "quantitative", title: "Commuter density (per km²)", axis: { grid: true } },
            y: { field: "PT_pct", type: "quantitative", title: "PT mode share (%)", axis: { grid: true } },
            size: { field: "PT_Total", type: "quantitative", title: "PT commuters", scale: { range: [20, 900] } },
            color: { value: "#1e3a8a" },
            tooltip: [
              { field: "SA2_NAME_2021", title: "Suburb (SA2)" },
              { field: "Density_commuters", type: "quantitative", title: "Commuter density", format: ",.0f" },
              { field: "PT_pct", type: "quantitative", title: "PT share", format: ".1f" },
              { field: "PT_Total", type: "quantitative", title: "PT commuters", format: "," },
              { field: "Area_sqkm", type: "quantitative", title: "Area (km²)", format: ",.2f" }
            ]
          }
        },
        {
          transform: [{ regression: "PT_pct", on: "Density_commuters", as: ["Density_commuters","PT_pct_fit"] }],
          mark: { type: "line", strokeWidth: 2 },
          encoding: {
            x: { field: "Density_commuters", type: "quantitative" },
            y: { field: "PT_pct_fit", type: "quantitative" },
            color: { value: "#ef4444" },
            order: { field: "Density_commuters" }
          }
        }
      ],
      config: { view: { stroke: null } }
    };

    /* -------- Render -------- */
    vegaEmbed('#map',          mapSpec,        { renderer: 'svg', actions: false });
    vegaEmbed('#stacked-area', stackedAreaSpec,{ renderer: 'svg', actions: false });
    vegaEmbed('#share-pair',   sharePairSpec,  { renderer: 'svg', actions: false });
    vegaEmbed('#sa2-scatter',  sa2ScatterSpec, { renderer: 'svg', actions: false });
  </script>
</body>
</html>
