<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Melbourne Public Transport – Data Story (ABS 2021 + PTV)</title>

  <!-- Vega, Vega-Lite, Vega-Embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    :root{
      --maxw: 1200px; --ink:#111827; --muted:#6b7280; --card:#ffffff; --bg:#fafafa; --rule:#e5e7eb;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:0 16px;}
    h1{font-size:2rem;margin:0 0 8px;}
    .subtitle{color:var(--muted);margin-bottom:24px;max-width:80ch}
    h2{font-size:1.35rem;margin:24px 0 6px}
    p.lead{color:var(--muted);margin:0 0 14px}
    .card{background:var(--card);border:1px solid var(--rule);border-radius:14px;padding:16px;margin:16px 0;box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .vis{width:100%}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:22px;align-items:start}
    .center-dropdown{display:flex;justify-content:center;gap:6px;margin-top:12px}
    .center-dropdown select{font-size:.95rem;padding:4px 6px}
    .smallnote{color:var(--muted);font-size:.9rem;margin-top:8px}
    footer{margin:32px 0;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Melbourne Public Transport – How Has it Evolved in Recent Years?</h1>
      <div class="subtitle">How Melburnians rely on PT (<strong>ABS 2021</strong>), how the transport mode mix has changed over time (<strong>PTV DataVic</strong>), and which stations anchor the network across Victoria.</div>
    </header>

    <!-- Section 1: Map (choropleth + station overlay) -->
    <section class="card">
      <h2>Where Melburnians Rely Most on Public Transport</h2>
      <p class="lead">Inner-city and corridor suburbs show the highest dependence on PT, reflecting dense rail and tram access. Triangle markers highlight the 20 busiest stations in the selected year—clustered around the CBD and key junctions like Richmond, Caulfield and Footscray.</p>
      <div id="map" class="vis"></div>
      <div class="smallnote">Sources: ABS 2021 Census (G62), ASGS 2021 SA2; PTV Annual Metropolitan Station Entries (FY20–21, FY23–24, FY24–25).</div>
    </section>

    <!-- Section 2: Mode mix over time -->
    <section class="card">
      <h2>How Public Transport Usage Evolved Before and After COVID-19</h2>
      <p class="lead">Usage fell sharply during 2020 when COVID hit, then steadily recovered after border reopenings in early 2022. Trains remain the backbone, with trams and buses providing steady inner-suburban and feeder capacity. Recovery is ongoing and still shy of pre-pandemic peaks, possibly influenced by the rise of working from home.</p>
      <div id="stacked-area" class="vis"></div>
      <div class="smallnote">Source: Department of Transport &amp; Planning (Vic) — Monthly public transport patronage by mode.</div>
    </section>

    <!-- NEW Section: Dual-axis line — PT (monthly) vs Migration (quarterly) -->
    <section class="card">
      <h2>Did Population Rebound with Public Transport?</h2>
      <p class="lead">PT usage is monthly (left axis) and net overseas migration to Victoria is quarterly (right axis).
        Migration rebounds strongly from 2022 and broadly tracks PT recovery; however, even with migration now
        above pre-COVID levels, PT usage has not fully matched that growth, suggesting other headwinds (e.g., WFH).
      </p>
      <div id="pt-vs-migration" class="vis"></div>
      <div class="smallnote">Sources: DTP Victoria (patronage by mode); ABS 3101.0 (Victoria — Net Overseas Migration).</div>
    </section>

    <!-- COMBINED Section: Mode pie + Stations bars side-by-side -->
    <section class="card">
      <h2>Modes vs Stations (Top 20)</h2>
      <div class="grid-2">
        <div>
          <p class="lead">Across the period, trains carry the largest share of trips, with trams dominating inner corridors and buses filling cross-suburban roles.</p>
          <div id="mode-pie" class="vis"></div>
        </div>
        <div>
          <p class="lead">Flinders Street eclipses all stations, followed by Southern Cross and Melbourne Central. CBD-adjacent interchanges dominate, while outer interchanges like Dandenong and Ringwood appear due to their role as suburban gateways.</p>
          <div id="stations-bars" class="vis"></div>
        </div>
      </div>
      <!-- One shared FY dropdown centered under BOTH charts -->
      <div class="center-dropdown">
        <label for="fy-select"><strong>FY&nbsp;</strong></label>
        <div id="fy-control"></div>
      </div>
    </section>

    <!-- Section 5: SA2 Scatter -->
    <section class="card">
      <h2>Does Density Drive Public Transport Use?</h2>
      <p class="lead">
        Suburbs (SA2) with more employed commuters per square kilometre tend to have a higher share using public transport.
        Bubble size shows the number of PT commuters. The red line is a linear regression fit. Outliers at the far right
        (e.g., Melbourne–CBD North) have very high densities but a lower PT share than expected in 2021; at the other end,
        coastal inner suburbs like Elwood also sit below the trend—likely reflecting gaps or indirect access to heavy rail
        compared with tram-rich or station-adjacent areas.
      </p>
      <div id="sa2-scatter" class="vis"></div>
      <div class="smallnote">Sources: ABS 2021 Census (SA2 boundaries &amp; travel to work).</div>
    </section>

  <script>
    // ========= Shared parameter pieces (single control drives both charts) =========
    const STATION_YEAR_NAME = "StationYear";
    const STATION_YEAR_DEFAULT = 2024;

    // Param for charts (no bind => no duplicate controls)
    const stationYearParamCharts = { name: STATION_YEAR_NAME, value: STATION_YEAR_DEFAULT };

    // Param for the single centered control
    const stationYearParamControl = {
      name: STATION_YEAR_NAME,
      value: STATION_YEAR_DEFAULT,
      bind: {
        input: "select",
        options: [2020, 2023, 2024],
        labels: ["2020–21 (COVID year)", "2023–24 (recovery)", "2024–25 (latest)"]
      }
    };

    // Shared colour scale for modes (use blue / green / grey across charts)
    const MODE_COLOUR = {
      domain: ["Metropolitan train","Metropolitan tram","Metropolitan bus"],
      range: ["#1e3a8a","#10b981","#9ca3af"] // train = navy, tram = green, bus = grey
    };

    // ===================== 1) MAP: choropleth + station overlay =====================
    const mapSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container",
      height: 560,
      autosize: { type: "fit", contains: "padding" },
      params: [stationYearParamCharts],
      projection: { type: "mercator" },
      data: { url: "data/melb_sa2_simplified.geojson", format: { type: "json", property: "features" } },
      transform: [
        { calculate: "toString(datum.properties.SA2_CODE_2021)", as: "SA2_CODE_2021_str" },
        {
          lookup: "SA2_CODE_2021_str",
          from: {
            data: { url: "data/abs_sa2_travel_to_work_2021.csv",
                    format: { type: "csv", parse: { SA2_CODE_2021: "string", PT_percent: "number", PT_Total: "number", Commuted_Total: "number" } } },
            key: "SA2_CODE_2021",
            fields: ["PT_percent","PT_Total","Commuted_Total"]
          }
        }
      ],
      layer: [
        { mark: { type: "geoshape", fill: "#f3f4f6", stroke: "#bdbfc3", strokeWidth: 0.6 } },
        {
          transform: [{ filter: "isValid(datum.PT_percent)" }],
          mark: { type: "geoshape", stroke: "#ffffff", strokeWidth: 0.35, opacity: 0.98 },
          encoding: {
            color: {
              field: "PT_percent",
              type: "quantitative",
              title: "% using Public Transport",
              scale: { type: "sqrt", domain: [0, 45], range: ["#dbeafe", "#60a5fa", "#2563eb", "#1e3a8a"], clamp: true }
            },
            tooltip: [
              { field: "properties.SA2_NAME_2021", title: "Area" },
              { field: "PT_percent", type: "quantitative", format: ".1f", title: "% PT" },
              { field: "PT_Total", type: "quantitative", title: "PT commuters" },
              { field: "Commuted_Total", type: "quantitative", title: "Commuters (excl. WFH)" }
            ]
          }
        },
        {
          data: { url: "data/station_usage.csv",
                  format: { type: "csv", parse: { Entries:"number", Latitude:"number", Longitude:"number", Year:"number" } } },
          transform: [
            { filter: "datum.Year == StationYear" },
            { window: [{ op: "rank", as: "rk" }], sort: [{ field: "Entries", order: "descending" }] },
            { filter: "datum.rk <= 20" }
          ],
          mark: { type: "point", shape: "triangle-up", filled: true, opacity: 0.85, stroke: "#111", strokeWidth: 0.9 },
          encoding: {
            longitude: { field: "Longitude", type: "quantitative" },
            latitude:  { field: "Latitude",  type: "quantitative" },
            size: { field: "Entries", type: "quantitative", title: "Entries", scale: { range: [40, 320] } },
            color: { value: "#000000" },
            tooltip: [
              { field: "Station", title: "Station" },
              { field: "Entries", type: "quantitative", title: "Entries", format: "," },
              { field: "Year", type: "quantitative" }
            ]
          }
        }
      ],
      config: { view: { stroke: null } }
    };

    // ===================== 2) MODE MIX: with COVID annotation =====================
    const stackedAreaSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container",
      height: 420,
      title: "Public Transport Usage Since 2018",
      autosize: { type: "fit", contains: "padding" },
      data: {
        url: "data/monthly_public_transport_patronage_by_mode.csv",
        format: {
          type: "csv",
          parse: {
            Year: "number",
            Month: "number",
            "Metropolitan train": "number",
            "Metropolitan tram": "number",
            "Metropolitan bus": "number"
          }
        }
      },
      transform: [
        { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Patronage"] },
        { calculate: "datetime(datum.Year, datum.Month-1, 1)", as: "MonthDate" }
      ],
      layer: [
        {
          selection: { mode_highlight: { type: "multi", fields: ["Mode"], bind: "legend" } },
          mark: { type: "area", interpolate: "monotone" },
          encoding: {
            x: { field: "MonthDate", type: "temporal", title: "Month" },
            y: { field: "Patronage", type: "quantitative", stack: "zero", title: "Trips", axis: { format: "~s" } },
            color: { field: "Mode", type: "nominal", title: "Mode", scale: MODE_COLOUR },
            opacity: { condition: { selection: "mode_highlight", value: 1 }, value: 0.25 },
            tooltip: [
              { field: "MonthDate", type: "temporal", title: "Month" },
              { field: "Mode" },
              { field: "Patronage", type: "quantitative", format: "," }
            ]
          }
        },
        { data: { values: [{ date: "2022-01-01" }] },
          mark: { type: "rule", color: "red", strokeDash: [4,3], strokeWidth: 2 },
          encoding: { x: { field: "date", type: "temporal" } }
        },
        {
          data: { values: [{ date: "2022-01-01", label: "Border reopening after COVID-19" }] },
          layer: [
            {
              mark: { type: "rect", fill: "white", opacity: 0.9 },
              encoding: {
                x: { field: "date", type: "temporal" }, xOffset: { value: 6 },
                x2: { field: "date", type: "temporal" }, x2Offset: { value: 220 },
                y: { datum: 0 }, y2: { datum: 10000000 }
              }
            },
            {
              mark: { type: "text", align: "left", dx: 10, dy: -10, color: "red", fontSize: 12, fontWeight: "bold" },
              encoding: { x: { field: "date", type: "temporal" }, y: { datum: 0 }, text: { field: "label" } }
            }
          ]
        }
      ]
    };

    // ===================== NEW: Dual-axis line: PT monthly vs NOM quarterly =====================
    const ptVsMigrationSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container",
      height: 420,
      autosize: { type: "fit", contains: "padding" },
      title: "Public Transport Recovery vs Net Overseas Migration (Victoria)",
      resolve: { scale: { y: "independent" }, legend: { color: "shared" } },
      layer: [
        {
          data: {
            url: "data/monthly_public_transport_patronage_by_mode.csv",
            format: {
              type: "csv",
              parse: {
                Year: "number",
                Month: "number",
                "Metropolitan train": "number",
                "Metropolitan tram": "number",
                "Metropolitan bus": "number"
              }
            }
          },
          transform: [
            { calculate: "datetime(datum.Year, datum.Month-1, 1)", as: "MonthDate" },
            { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Trips"] },
            { aggregate: [{ op: "sum", field: "Trips", as: "PT_Total" }], groupby: ["MonthDate"] },
            { calculate: "'PT trips'", as: "Series" }
          ],
          mark: { type: "line", interpolate: "monotone", strokeWidth: 2 },
          encoding: {
            x: { field: "MonthDate", type: "temporal", title: "Year",
                 scale: { domainMin: "2018-01-01" },
                 axis: { format: "%Y", tickCount: "year", labelFlush: true } },
            y: { field: "PT_Total", type: "quantitative",
                 title: "PT trips (monthly total)",
                 axis: { format: "~s", grid: true },
                 scale: { nice: true, zero: true } },
            color: { field: "Series",
                     scale: { domain: ["PT trips","Net overseas migration"], range: ["#1e3a8a","#f59e0b"] },
                     legend: { title: "Series" } },
            tooltip: [
              { field: "MonthDate", type: "temporal", title: "Month" },
              { field: "PT_Total", type: "quantitative", title: "PT trips", format: "," }
            ]
          }
        },
        {
          data: { url: "data/vic_migration_quarterly.csv",
                  format: { type: "csv", parse: { QuarterDate: "date", NOM: "number" } } },
          transform: [
            { calculate: "'Net overseas migration'", as: "Series" },
            { filter: "toDate(datum.QuarterDate) >= toDate('2018-01-01')" }
          ],
          mark: { type: "line", interpolate: "step-after", strokeWidth: 2 },
          encoding: {
            x: { field: "QuarterDate", type: "temporal",
                 scale: { domainMin: "2018-01-01" },
                 axis: { format: "%Y", tickCount: "year", labelFlush: true } },
            y: { field: "NOM", type: "quantitative",
                 title: "Net overseas migration (quarterly, Victoria)",
                 axis: { orient: "right", format: "~s", grid: false } },
            color: { field: "Series",
                     scale: { domain: ["PT trips","Net overseas migration"], range: ["#1e3a8a","#f59e0b"] } },
            tooltip: [
              { field: "QuarterDate", type: "temporal", title: "Quarter" },
              { field: "NOM", type: "quantitative", title: "NOM", format: "," }
            ]
          }
        },
        { data: { values: [{ date: "2022-01-01" }] },
          mark: { type: "rule", color: "#ef4444", strokeDash: [4,3], strokeWidth: 2 },
          encoding: { x: { field: "date", type: "temporal" } } },
        {
          data: { values: [{ date: "2022-01-01", label: "Border reopening\n(early 2022)" }] },
          layer: [
            { mark: { type: "rect", fill: "white", opacity: 0.95 },
              encoding: { x: { field: "date", type: "temporal" }, xOffset: { value: 6 },
                          x2: { field: "date", type: "temporal" }, x2Offset: { value: 170 },
                          y: { datum: 0, axis: null }, y2: { datum: 1, axis: null } } },
            { mark: { type: "text", align: "left", dx: 10, dy: -14, color: "#ef4444", fontSize: 12, fontWeight: "bold" },
              encoding: { x: { field: "date", type: "temporal" }, y: { datum: 0, axis: null }, text: { field: "label" } } }
          ]
        }
      ],
      config: { view: { stroke: null } }
    };

    // ===================== Mode DONUT (legend bigger; title; tooltip kept) =====================
    const modePieSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      title: "Mode Share (Selected FY)",
      width: "container",
      height: 450,
      autosize: { type: "fit", contains: "padding" },
      params: [stationYearParamCharts],
      data: {
        url: "data/monthly_public_transport_patronage_by_mode.csv",
        format: {
          type: "csv",
          parse: {
            Year: "number",
            Month: "number",
            "Metropolitan train": "number",
            "Metropolitan tram": "number",
            "Metropolitan bus": "number"
          }
        }
      },
      transform: [
        { calculate: "datum.Month >= 7 ? datum.Year : datum.Year - 1", as: "FiscalStart" },
        { filter: "datum.FiscalStart == StationYear" },
        { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Patronage"] },
        { aggregate: [{ op: "sum", field: "Patronage", as: "TotalTrips" }], groupby: ["Mode"] },
        { window: [{ op: "sum", field: "TotalTrips", as: "AllTrips" }] },
        { calculate: "datum.TotalTrips / datum.AllTrips", as: "share" },
        { calculate: "replace(datum.Mode,'Metropolitan ','')", as: "ModeShort" }
      ],
      encoding: {
        theta: { field: "TotalTrips", type: "quantitative", stack: true },
        color: {
          field: "Mode",
          type: "nominal",
          scale: MODE_COLOUR,
          legend: {
            title: "Mode",
            orient: "bottom",
            direction: "horizontal",
            labelExpr: "replace(datum.label, 'Metropolitan ', '')",
            titleFontSize: 14,
            labelFontSize: 14,
            symbolSize: 220
          }
        },
        order: { field: "TotalTrips", sort: "descending" }
      },
      layer: [
        {
          mark: { type: "arc", innerRadius: 100, outerRadius: 190 },
          encoding: {
            tooltip: [
              { field: "ModeShort", title: "Mode" },
              { field: "TotalTrips", type: "quantitative", title: "Trips", format: "," },
              { field: "share", type: "quantitative", title: "Share", format: ".0%" }
            ]
          }
        },
        {
          mark: { type: "text", radius: 145, fontWeight: "bold", fontSize: 14, fill: "white", align: "center", baseline: "middle" },
          encoding: { text: { field: "share", type: "quantitative", format: ".0%" } }
        }
      ],
      config: { view: { stroke: null } }
    };

    // ===================== STATIONS: Top-20 bar with title (uses shared FY) =====================
    const stationsBarSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      title: "Busiest Stations (Top 20, Selected FY)",
      width: "container",
      height: 520,
      autosize: { type: "fit", contains: "padding" },
      params: [stationYearParamCharts],
      data: { url: "data/station_usage.csv", format: { type: "csv", parse: { Entries: "number", Year: "number" } } },
      transform: [
        { filter: "datum.Year == StationYear" },
        { window: [{ op: "rank", as: "rk" }], sort: [{ field: "Entries", order: "descending" }] },
        { filter: "datum.rk <= 20" }
      ],
      mark: { type: "bar", cornerRadiusTopLeft: 6, cornerRadiusTopRight: 6 },
      encoding: {
        y: { field: "Station", type: "nominal", sort: "-x", title: "Station" },
        x: { field: "Entries", type: "quantitative", title: "Annual entries", axis: { format: "~s" } },
        color: { value: "#1e3a8a" },
        tooltip: [
          { field: "Station" },
          { field: "Entries", type: "quantitative", format: "," },
          { field: "Year", type: "quantitative" }
        ]
      }
    };

    // ============ Minimal spec to host the single bound FY dropdown (centered below both charts) ============
    const fyControlSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 1, height: 1,
      params: [stationYearParamControl],
      data: { values: [{}] },
      mark: { type: "point", opacity: 0 } // invisible; just renders the control
    };

    // ===================== 5) SA2 SCATTER: points + regression =====================
    const sa2ScatterSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container",
      height: 460,
      autosize: { type: "fit", contains: "padding" },
      data: {
        url: "data/sa2_pt_density.csv",
        format: {
          type: "csv",
          parse: {
            Density_commuters: "number",
            PT_percent: "number",
            PT_Total: "number",
            Area_sqkm: "number"
          }
        }
      },
      transform: [{ calculate: "datum.PT_percent", as: "PT_pct" }],
      layer: [
        {
          mark: { type: "point", filled: true, opacity: 0.7 },
          encoding: {
            x: { field: "Density_commuters", type: "quantitative", title: "Commuter density (per km²)", axis: { grid: true } },
            y: { field: "PT_pct", type: "quantitative", title: "PT mode share (%)", axis: { grid: true } },
            size: { field: "PT_Total", type: "quantitative", title: "PT commuters", scale: { range: [20, 900] } },
            color: { value: "#1e3a8a" },
            tooltip: [
              { field: "SA2_NAME_2021", title: "Suburb (SA2)" },
              { field: "Density_commuters", type: "quantitative", title: "Commuter density", format: ",.0f" },
              { field: "PT_pct", type: "quantitative", title: "PT share", format: ".1f" },
              { field: "PT_Total", type: "quantitative", title: "PT commuters", format: "," },
              { field: "Area_sqkm", type: "quantitative", title: "Area (km²)", format: ",.2f" }
            ]
          }
        },
        {
          transform: [{ regression: "PT_pct", on: "Density_commuters", as: ["Density_commuters", "PT_pct_fit"] }],
          mark: { type: "line", strokeWidth: 2 },
          encoding: {
            x: { field: "Density_commuters", type: "quantitative" },
            y: { field: "PT_pct_fit", type: "quantitative" },
            color: { value: "#ef4444" },
            order: { field: "Density_commuters" }
          }
        }
      ],
      config: { view: { stroke: null } }
    };

    // ===================== Render (SVG = crisp) =====================
    vegaEmbed('#map',             mapSpec,           { renderer: 'svg', actions: false });
    vegaEmbed('#stacked-area',    stackedAreaSpec,   { renderer: 'svg', actions: false });
    vegaEmbed('#pt-vs-migration', ptVsMigrationSpec, { renderer: 'svg', actions: false });

    // Combined section renders
    const pieP  = vegaEmbed('#mode-pie',      modePieSpec,     { renderer: 'svg', actions: false });
    const barP  = vegaEmbed('#stations-bars', stationsBarSpec, { renderer: 'svg', actions: false });
    const fyP   = vegaEmbed('#fy-control',    fyControlSpec,   { renderer: 'svg', actions: false });

    // Wire the single control to both charts (and initialize them to its current value)
    Promise.all([pieP, barP, fyP]).then(([pie, bars, fy]) => {
      const initVal = fy.view.signal(STATION_YEAR_NAME);
      pie.view.signal(STATION_YEAR_NAME, initVal).run();
      bars.view.signal(STATION_YEAR_NAME, initVal).run();

      fy.view.addSignalListener(STATION_YEAR_NAME, (_name, val) => {
        pie.view.signal(STATION_YEAR_NAME, val).run();
        bars.view.signal(STATION_YEAR_NAME, val).run();
      });
    });

    vegaEmbed('#sa2-scatter',     sa2ScatterSpec,    { renderer: 'svg', actions: false });
  </script>

  <footer>
    <p><strong>Author:</strong> Greg Umansky &nbsp; | &nbsp; <strong>Date:</strong> 21 Oct 2025</p>
  </footer>
</body>
</html>
