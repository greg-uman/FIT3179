<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Melbourne Public Transport – Data Story (ABS 2021 + PTV)</title>

  <!-- Vega, Vega-Lite, Vega-Embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    :root{
  --maxw: 1200px;
  --ink:#0A1A4F;     /* Dark navy for headings */
  --ink2:#21325E;    /* Slightly lighter navy for body text */
  --muted:#6b7280;
  --card:#ffffff;
  --bg:#f4f5fb;
  --rule:#e5e7eb;
}
h1, h2 {
  color: var(--ink);          /* dark navy headings */
}

.subtitle, p, .smallnote, .lead, body {
  color: var(--ink2);         /* slightly lighter navy text */
}

html,body {
  margin:0;
  padding:0;
  background:var(--bg);
  font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}    .wrap{max-width:var(--maxw);margin:28px auto;padding:0 16px;}

    p.lead{color:var(--muted);margin:0 0 14px}
    .card{background:var(--card);border:1px solid var(--rule);border-radius:14px;padding:16px;margin:16px 0;box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .vis{width:100%}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:22px;align-items:start}
    .center-dropdown{display:flex;justify-content:center;gap:6px;margin-top:12px}
    .center-dropdown select{font-size:.95rem;padding:4px 6px}
    .smallnote{color:var(--muted);font-size:.9rem;margin-top:8px}
    footer{margin:32px 0;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Melbourne's Public Transport Landscape – How Has it Evolved in Recent Years?</h1>
      <!-- fixed stray closing tag -->
      <div class="subtitle">Mapping Melbourne’s Public Transport story: who depends on it (ABS 2021), how mode share has evolved alongside population trends, and the stations that anchor the network.</div>
    </header>

    <!-- Section 1: Map (choropleth + station overlay) -->
    <section class="card">
      <h2>Where Melburnians Rely Most on Public Transport</h2>
      <p class="lead">Inner-city and corridor suburbs show the highest dependence on PT, reflecting dense rail and tram access. Triangle markers highlight the 20 busiest stations in the selected year -clustered around the CBD and key junctions like Richmond, Caulfield and Footscray.</p>
      <div id="map" class="vis"></div>
      <div class="smallnote">Sources: ABS 2021 Census (G62), ASGS 2021 SA2; PTV Annual Metropolitan Station Entries (FY20–21, FY23–24, FY24–25).</div>
    </section>

    <!-- Section 2: Mode mix over time -->
    <section class="card">
      <h2>How Public Transport Usage Evolved Before and After COVID-19</h2>
      <p class="lead">Usage fell sharply during 2020 when COVID hit, then steadily recovered after border reopenings in early 2022. Trains remain the backbone, with trams and buses providing steady inner-suburban and feeder capacity. Recovery is ongoing and still shy of pre-pandemic peaks, possibly influenced by the rise of working from home.</p>
      <div id="stacked-area" class="vis"></div>
      <div class="smallnote">Source: Department of Transport &amp; Planning (Vic) — Monthly public transport patronage by mode.</div>
    </section>

    <!-- Section 3: PT vs Migration -->
    <section class="card">
      <h2>Did Population Rebound with Public Transport?</h2>
      <p class="lead">PT usage is monthly (left axis) and net overseas migration to Victoria is quarterly (right axis).
        Migration rebounds strongly from 2022 and broadly tracks PT recovery; however, even with migration now
        above pre-COVID levels, PT usage has not fully matched that growth, suggesting other headwinds (e.g., WFH).
      </p>
      <div id="pt-vs-Immigration" class="vis"></div>
      <div class="smallnote">Sources: DTP Victoria (patronage by mode); ABS 3101.0 (Victoria — Net Overseas Migration).</div>
    </section>

    <!-- Section 4: Modes vs Stations (shared FY control) -->
    <section class="card">
      <h2>Modes vs Stations (Top 20)</h2>
      <div class="grid-2">
        <div>
          <p class="lead">Across the period, trains carry the largest share of trips, with trams dominating inner corridors and buses filling cross-suburban roles.</p>
          <div id="mode-pie" class="vis"></div>
        </div>
        <div>
          <p class="lead">Flinders Street eclipses all stations, followed by Southern Cross and Melbourne Central. CBD-adjacent interchanges dominate, while outer interchanges like Dandenong and Ringwood appear due to their role as suburban gateways.</p>
          <div id="stations-bars" class="vis"></div>
        </div>
      </div>
      <!-- single shared FY dropdown: hosting spec renders here -->
      <div class="center-dropdown">
        <div id="fy-control"></div>
      </div>
    </section>

    <!-- Section 5: SA2 Scatter -->
    <section class="card">
      <h2>Does Density Drive Public Transport Use?</h2>
      <p class="lead">
        <p class="lead">
  Suburbs (SA2) with more employed commuters per square kilometre tend to have a higher share using public transport.
  Bubble size shows the number of PT commuters. The red line is a linear regression fit. 
  Notably, <strong>Elwood</strong> and <strong>Port Melbourne</strong> sit <em>below</em> the line of best fit, both have comparatively poorer heavy-rail access and rely more on indirect tram/bus connections, while <strong>Docklands</strong> sits <em>above</em> the line, buoyed by immediate access to major hubs like <strong>Southern Cross</strong> and the CBD tram spine.
      </p>
      <div id="sa2-scatter" class="vis"></div>
      <div class="smallnote">Sources: ABS 2021 Census (SA2 boundaries &amp; travel to work).</div>
    </section>

  <script>
    /* ============================================================
       0) Global shared FY parameter (used by pie + stations + map)
       ============================================================ */
    const STATION_YEAR_NAME = "StationYear";
    const STATION_YEAR_DEFAULT = 2024;

    // Charts listen to this signal (no bind => avoids rendering extra selects)
    const stationYearParamCharts = { name: STATION_YEAR_NAME, value: STATION_YEAR_DEFAULT };

    // The one visible dropdown control (renders inside #fy-control)
    const stationYearParamControl = {
      name: STATION_YEAR_NAME,
      value: STATION_YEAR_DEFAULT,
      bind: {
        input: "select",
        options: [2018, 2019, 2020, 2021, 2022, 2023, 2024],
        labels: ["FY18–19","FY19–20","FY20–21","FY21–22","FY22–23","FY23–24","FY24–25"]
      }
    };

    // Shared colour palette across charts
    const MODE_COLOUR = {
      domain: ["Metropolitan train","Metropolitan tram","Metropolitan bus"],
      range: ["#1e3a8a","#10b981","#9ca3af"]
    };

    /* ============================================================
       1) MAP (choropleth + Top-20 station overlay; shares FY signal)
       ============================================================ */
    const mapSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container",
      height: 560,
      autosize: { type: "fit", contains: "padding" },
      params: [stationYearParamCharts],
      projection: { type: "mercator" },
      data: { url: "data/melb_sa2_simplified.geojson", format: { type: "json", property: "features" } },
      transform: [
        { calculate: "toString(datum.properties.SA2_CODE_2021)", as: "SA2_CODE_2021_str" },
        {
          lookup: "SA2_CODE_2021_str",
          from: {
            data: {
              url: "data/abs_sa2_travel_to_work_2021.csv",
              format: { type: "csv", parse: { SA2_CODE_2021: "string", PT_percent: "number", PT_Total: "number", Commuted_Total: "number" } }
            },
            key: "SA2_CODE_2021",
            fields: ["PT_percent","PT_Total","Commuted_Total"]
          }
        }
      ],
      layer: [
        { mark: { type: "geoshape", fill: "#f3f4f6", stroke: "#bdbfc3", strokeWidth: 0.6 } },
        {
          transform: [{ filter: "isValid(datum.PT_percent)" }],
          mark: { type: "geoshape", stroke: "#ffffff", strokeWidth: 0.35, opacity: 0.98 },
          encoding: {
            color: {
              field: "PT_percent",
              type: "quantitative",
              title: "% using Public Transport",
              scale: { type: "sqrt", domain: [0, 45], range: ["#dbeafe", "#60a5fa", "#2563eb", "#1e3a8a"], clamp: true }
            },
            tooltip: [
              { field: "properties.SA2_NAME_2021", title: "Area" },
              { field: "PT_percent", type: "quantitative", format: ".1f", title: "% PT" },
              { field: "PT_Total", type: "quantitative", title: "PT commuters" },
              { field: "Commuted_Total", type: "quantitative", title: "Commuters (excl. WFH)" }
            ]
          }
        },
        {
          data: { url: "data/station_usage2.csv",
                  format: { type: "csv", parse: { Entries:"number", Latitude:"number", Longitude:"number", Year:"number" } } },
          transform: [
            { filter: "datum.Year == StationYear" },
            { window: [{ op: "rank", as: "rk" }], sort: [{ field: "Entries", order: "descending" }] },
            { filter: "datum.rk <= 20" }
          ],
          mark: { type: "point", shape: "triangle-up", filled: true, opacity: 0.85, stroke: "#111", strokeWidth: 0.9 },
          encoding: {
            longitude: { field: "Longitude", type: "quantitative" },
            latitude:  { field: "Latitude",  type: "quantitative" },
            size: { field: "Entries", type: "quantitative", title: "Entries", scale: { range: [40, 320] } },
            color: { value: "#000000" },
            tooltip: [
              { field: "Station", title: "Station" },
              { field: "Entries", type: "quantitative", title: "Entries", format: "," },
              { field: "Year", type: "quantitative" }
            ]
          }
        }
      ],
      config: { view: { stroke: null } }
    };

    /* ============================================================
       2) MODE MIX (stacked area with COVID annotation)
       ============================================================ */
    const stackedAreaSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container",
      height: 420,
      title: "Public Transport Usage Since 2018",
      autosize: { type: "fit", contains: "padding" },
      data: {
        url: "data/monthly_public_transport_patronage_by_mode.csv",
        format: {
          type: "csv",
          parse: {
            Year: "number",
            Month: "number",
            "Metropolitan train": "number",
            "Metropolitan tram": "number",
            "Metropolitan bus": "number"
          }
        }
      },
      transform: [
        { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Patronage"] },
        { calculate: "datetime(datum.Year, datum.Month-1, 1)", as: "MonthDate" }
      ],
      layer: [
        {
          selection: { mode_highlight: { type: "multi", fields: ["Mode"], bind: "legend" } },
          mark: { type: "area", interpolate: "monotone" },
          encoding: {
            x: { field: "MonthDate", type: "temporal", title: "Month" },
            y: { field: "Patronage", type: "quantitative", stack: "zero", title: "Trips", axis: { format: "~s" } },
            color: { field: "Mode", type: "nominal", title: "Mode", scale: MODE_COLOUR },
            opacity: { condition: { selection: "mode_highlight", value: 1 }, value: 0.25 },
            tooltip: [
              { field: "MonthDate", type: "temporal", title: "Month" },
              { field: "Mode" },
              { field: "Patronage", type: "quantitative", format: "," }
            ]
          }
        },
        { data: { values: [{ date: "2022-01-01" }] },
          mark: { type: "rule", color: "red", strokeDash: [4,3], strokeWidth: 2 },
          encoding: { x: { field: "date", type: "temporal" } }
        },
        {
          data: { values: [{ date: "2022-01-01", label: "Border reopening after COVID-19" }] },
          layer: [ 
            {
              mark: { type: "text", align: "left", dx: 10, dy: -10, color: "red", fontSize: 12, fontWeight: "bold" },
              encoding: { x: { field: "date", type: "temporal" }, y: { datum: 0 }, text: { field: "label" } }
            }
          ]
        }
      ]
    };

    /* ============================================================
       3) PT (monthly) vs Net Immigration (quarterly)
       ============================================================ */
    const ptVsMigrationSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: "container",
      height: 420,
      autosize: { type: "fit", contains: "padding" },
      title: "Public Transport Recovery vs Net Immigration into Victoria",
      resolve: { scale: { y: "independent" }, legend: { color: "shared" } },
      layer: [
        {
          data: {
            url: "data/monthly_public_transport_patronage_by_mode.csv",
            format: {
              type: "csv",
              parse: {
                Year: "number",
                Month: "number",
                "Metropolitan train": "number",
                "Metropolitan tram": "number",
                "Metropolitan bus": "number"
              }
            }
          },
          transform: [
            { calculate: "datetime(datum.Year, datum.Month-1, 1)", as: "MonthDate" },
            { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Trips"] },
            { aggregate: [{ op: "sum", field: "Trips", as: "PT_Total" }], groupby: ["MonthDate"] },
            { calculate: "'PT trips'", as: "Series" }
          ],
          mark: { type: "line", interpolate: "monotone", strokeWidth: 2 },
          encoding: {
            x: { field: "MonthDate", type: "temporal", title: "Year", scale: { domainMin: "2018-01-01" }, axis: { format: "%Y", tickCount: "year", labelFlush: true } },
            y: { field: "PT_Total", type: "quantitative", title: "PT trips (monthly total)", axis: { format: "~s", grid: true }, scale: { nice: true, zero: true } },
            color: { field: "Series", scale: { domain: ["PT trips","Net Immigration"], range: ["#065f46","#f59e0b"] }, legend: { title: "Series" } }
          }
        },
        {
          data: { url: "data/vic_migration_quarterly.csv", format: { type: "csv", parse: { QuarterDate: "date", NOM: "number" } } },
          transform: [
            { calculate: "'Net Immigration'", as: "Series" },
            { filter: "toDate(datum.QuarterDate) >= toDate('2018-01-01')" }
          ],
          mark: { type: "line", interpolate: "step-after", strokeWidth: 2 },
          encoding: {
            x: { field: "QuarterDate", type: "temporal", scale: { domainMin: "2018-01-01" }, axis: { format: "%Y", tickCount: "year", labelFlush: true } },
            y: { field: "NOM", type: "quantitative", title: "Net Immigration (quarterly, Victoria)", axis: { orient: "right", format: "~s", grid: false } },
            color: { field: "Series", scale: { domain: ["PT trips","Net Immigration"], range: ["#1e3a8a","#f59e0b"] } },
            tooltip: [
              { field: "QuarterDate", type: "temporal", title: "Quarter" },
              { field: "NOM", type: "quantitative", title: "NOM", format: "," }
            ]
          }
        },
        { data: { values: [{ date: "2022-01-01" }] },
          mark: { type: "rule", color: "#ef4444", strokeDash: [4,3], strokeWidth: 2 },
          encoding: { x: { field: "date", type: "temporal" } } }
      ],
      config: { view: { stroke: null } }
    };

    /* ============================================================
       4) Mode DONUT (shares FY signal)
       ============================================================ */
    const modePieSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      title: "Mode Share (Selected FY)",
      width: "container",
      height: 450,
      autosize: { type: "fit", contains: "padding" },
      params: [stationYearParamCharts],
      data: {
        url: "data/monthly_public_transport_patronage_by_mode.csv",
        format: {
          type: "csv",
          parse: { Year: "number", Month: "number", "Metropolitan train": "number", "Metropolitan tram": "number", "Metropolitan bus": "number" }
        }
      },
      transform: [
        { calculate: "datum.Month >= 7 ? datum.Year : datum.Year - 1", as: "FiscalStart" },
        { filter: "datum.FiscalStart == StationYear" },
        { fold: ["Metropolitan train","Metropolitan tram","Metropolitan bus"], as: ["Mode","Patronage"] },
        { aggregate: [{ op: "sum", field: "Patronage", as: "TotalTrips" }], groupby: ["Mode"] },
        { window: [{ op: "sum", field: "TotalTrips", as: "AllTrips" }] },
        { joinaggregate: [{ op: "sum", field: "TotalTrips", as: "AllTrips" }] },
        { calculate: "datum.TotalTrips / datum.AllTrips", as: "share" },
      ],
      encoding: {
        theta: { field: "TotalTrips", type: "quantitative", stack: true },
        color: {
          field: "Mode", type: "nominal", scale: MODE_COLOUR,
          legend: { title: "Mode", orient: "bottom", direction: "horizontal", labelExpr: "replace(datum.label, 'Metropolitan ', '')", titleFontSize: 14, labelFontSize: 14, symbolSize: 220 }
        },
        order: { field: "TotalTrips", sort: "descending" }
      },
      layer: [
        { mark: { type: "arc", innerRadius: 100, outerRadius: 190 },
          encoding: { tooltip: [{ field: "ModeShort", title: "Mode" }, { field: "TotalTrips", type: "quantitative", title: "Trips", format: "," }, { field: "share", type: "quantitative", title: "Share", format: ".0%" }] } },
        { mark: { type: "text", radius: 145, fontWeight: "bold", fontSize: 14, fill: "white", align: "center", baseline: "middle" },
          encoding: { text: { field: "share", type: "quantitative", format: ".0%" } } }
      ],
      config: { view: { stroke: null } }
    };

    /* ============================================================
       5) STATIONS Top-20 (shares FY signal)
       ============================================================ */
    const stationsBarSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      title: "Busiest Stations (Top 20, Selected FY)",
      width: "container",
      height: 520,
      autosize: { type: "fit", contains: "padding" },
      params: [stationYearParamCharts],
      data: { url: "data/station_usage2.csv", format: { type: "csv", parse: { Entries: "number", Year: "number" } } },
      transform: [
        { filter: "datum.Year == StationYear" },
        { window: [{ op: "rank", as: "rk" }], sort: [{ field: "Entries", order: "descending" }] },
        { filter: "datum.rk <= 20" }
      ],
      mark: { type: "bar", cornerRadiusTopLeft: 6, cornerRadiusTopRight: 6 },
      encoding: {
        y: { field: "Station", type: "nominal", sort: "-x", title: "Station" },
        x: { field: "Entries", type: "quantitative", title: "Annual entries", axis: { format: "~s" } },
        color: { value: "#1e3a8a" },
        tooltip: [{ field: "Station" }, { field: "Entries", type: "quantitative", format: "," }, { field: "Year", type: "quantitative" }]
      }
    };

    /* ============================================================
       6) Invisible spec to render the single bound FY dropdown
       ============================================================ */
    const fyControlSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 1, height: 1,
      params: [stationYearParamControl],
      data: { values: [{}] },
      mark: { type: "point", opacity: 0 } // just hosts the <select>
    };


  /* ============================================================
   7) SA2 Scatter (density vs PT share) — tooltips restored
   ============================================================*/
const sa2ScatterSpec = {
  $schema: "https://vega.github.io/schema/vega-lite/v5.json",
  width: "container",
  height: 460,
  autosize: { type: "fit", contains: "padding" },
  data: {
    url: "data/sa2_pt_density.csv",
    format: {
      type: "csv",
      parse: {
        Density_commuters: "number",
        PT_percent: "number",
        PT_Total: "number",
        Area_sqkm: "number"
      }
    }
  },
  transform: [{ calculate: "datum.PT_percent", as: "PT_pct" }],
  layer: [
    // Keep the regression line, but draw it first so points sit above it.
    {
      transform: [
        { regression: "PT_pct", on: "Density_commuters", as: ["Density_commuters", "PT_pct_fit"] }
      ],
      mark: { type: "line", strokeWidth: 2, color: "#ef4444" },
      encoding: {
        x: { field: "Density_commuters", type: "quantitative" },
        y: { field: "PT_pct_fit", type: "quantitative" }
      }
    },

    // Points with full tooltip details 
    {
      mark: { type: "point", filled: true, opacity: 0.7 },
      encoding: {
        x: { field: "Density_commuters", type: "quantitative", title: "Commuter density (per km²)", axis: { grid: true } },
        y: { field: "PT_pct", type: "quantitative", title: "PT mode share (%)", axis: { grid: true } },
        size: { field: "PT_Total", type: "quantitative", title: "PT commuters", scale: { range: [20, 900] } },
        color: { value: "#4c1d95" },
        tooltip: [
          { field: "SA2_NAME_2021", title: "Suburb (SA2)" },
          { field: "Density_commuters", type: "quantitative", title: "Commuter density", format: ",.0f" },
          { field: "PT_pct", type: "quantitative", title: "PT share (%)", format: ".1f" },
          { field: "PT_Total", type: "quantitative", title: "PT commuters", format: "," },
          { field: "Area_sqkm", type: "quantitative", title: "Area (km²)", format: ",.2f" }
        ]
      }
    }
  ],
  config: { view: { stroke: null } }
};

    /* ============================================================
       8) Render (SVG = crisp) and wire the FY control
       ============================================================ */
    vegaEmbed('#map',             mapSpec,             { renderer: 'svg', actions: false });
    vegaEmbed('#stacked-area',    stackedAreaSpec,     { renderer: 'svg', actions: false });
    vegaEmbed('#pt-vs-Immigration', ptVsMigrationSpec, { renderer: 'svg', actions: false });
    vegaEmbed('#sa2-scatter',     sa2ScatterSpec,      { renderer: 'svg', actions: false });

    // These three visuals share the FY dropdown
    const pieP  = vegaEmbed('#mode-pie',      modePieSpec,     { renderer: 'svg', actions: false });
    const barP  = vegaEmbed('#stations-bars', stationsBarSpec, { renderer: 'svg', actions: false });
    const fyP   = vegaEmbed('#fy-control',    fyControlSpec,   { renderer: 'svg', actions: false });

    // Keep the FY select and the two charts in sync
    Promise.all([pieP, barP, fyP]).then(([pie, bars, fy]) => {
      const initVal = fy.view.signal(STATION_YEAR_NAME);
      pie.view.signal(STATION_YEAR_NAME, initVal).run();
      bars.view.signal(STATION_YEAR_NAME, initVal).run();

      fy.view.addSignalListener(STATION_YEAR_NAME, (_name, val) => {
        pie.view.signal(STATION_YEAR_NAME, val).run();
        bars.view.signal(STATION_YEAR_NAME, val).run();
      });
    });
  </script>

  <footer>
    <p><strong>Author:</strong> Greg Umansky &nbsp; | &nbsp; <strong>Date:</strong> 21 Oct 2025</p>
  </footer>
</body>
</html>
